name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper diff

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check PR title
      run: |
        echo "PR Title: ${{ github.event.pull_request.title }}"
        # Check for conventional commit format (optional)
        if [[ "${{ github.event.pull_request.title }}" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?:\ .+ ]]; then
          echo "✓ PR title follows conventional commit format"
        else
          echo "⚠ PR title doesn't follow conventional commit format (optional)"
        fi

    - name: Run quick tests
      run: |
        pytest tests/ -v -x --tb=short

    - name: Check for breaking changes
      run: |
        # Check if core APIs are modified
        git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "agentic_playground/core/(agent|orchestrator|message)\.py" && echo "⚠ Core API files modified - ensure backward compatibility" || echo "✓ No core API changes"

    - name: Verify imports still work
      run: |
        python -c "from agentic_playground import Agent, AgentConfig, Message, Orchestrator; print('✓ Core imports work')"

    - name: Check file sizes
      run: |
        # Check for large files
        find . -type f -size +1M -not -path "./.git/*" -not -path "./data/*" | while read file; do
          echo "⚠ Large file detected: $file"
        done || echo "✓ No large files"

    - name: Lint changed files
      run: |
        # Get list of changed Python files
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' || true)
        if [ -n "$CHANGED_FILES" ]; then
          echo "Linting changed files:"
          echo "$CHANGED_FILES"
          ruff check $CHANGED_FILES || true
        else
          echo "No Python files changed"
        fi

  comment:
    runs-on: ubuntu-latest
    needs: validate
    if: always()

    steps:
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ needs.validate.result }}';
          const emoji = status === 'success' ? '✅' : '❌';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${emoji} PR validation ${status}!\n\nView details in the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          })
